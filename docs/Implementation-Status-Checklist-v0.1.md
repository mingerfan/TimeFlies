# TimeFiles 实施状态清单（v0.1）

- 校对日期：2026-02-25
- 校对范围：`PRD-TimeFiles-v0.1.md`、`MVP-Execution-Plan-v0.1.md`、`ADR-Core-Decisions-v0.1.md`
- 判定依据：当前代码实现（`src-tauri/` + `src/`）
- 复选框说明：`[x]` 已完成，`[ ]` 未完成（含部分完成）

## 1) PRD（MVP 必做）对照

- [x] 任务树管理：支持创建任务、创建子任务、前端树形展示。
- [x] 任务树管理：重命名、归档（软删除）、父子关系调整（reparent）已实现。
- [x] 任务计时：开始/暂停/恢复/停止已实现（Rust 命令 + 前端操作）。
- [x] 运行中插入子任务：父任务自动 pause，子任务 stop 后父任务自动 resume。
- [x] 标签系统：任务添加/删除标签，标签可复用。
- [ ] 标签筛选与按标签统计聚合尚未实现（目前仅任务级统计 + 标签展示）。
- [x] 时间统计：任务 `inclusive_time` / `exclusive_time` 已实现并在 UI 展示。
- [ ] 瓶颈提示（规则版）尚未实现。
- [x] 自适应休息建议（`0/3/8/15`）已实现（含建议原因展示与接受/忽略交互）。
- [x] 本地优先存储：SQLite 本地落盘（`timeflies.db`）。

## 2) PRD 功能需求（FR）对照

### FR-001 任务树

- [x] 新增任务、子任务创建可用。
- [x] 重命名、软删除、父子关系调整已实现。
- [x] “避免循环引用”机制已实现（reparent 禁止挂到自身/后代，并检测祖先链异常环）。

### FR-002 计时状态机

- [x] 状态机状态：`idle/running/paused/stopped` 已实现。
- [x] 单活动上下文（同一时刻仅一个 running）已实现。
- [x] 插入子任务自动 pause/resume 语义已实现。
- [ ] 状态机相关自动化测试尚未补齐（实现在，测试缺失）。

### FR-003 标签系统

- [x] 任务 0~N 标签、标签复用已实现。
- [ ] 按标签筛选任务未实现。
- [ ] 按标签统计汇总未实现。

### FR-004 统计与瓶颈

- [x] 任务 `inclusive/exclusive` 计算与展示已实现。
- [x] 日/周/全量时间窗口统计已实现。
- [ ] 任务树节点耗时占比未实现。
- [ ] 标签聚合统计未实现。
- [ ] 规则版瓶颈提示未实现。

### FR-005 自适应休息建议

- [x] 触发逻辑（子任务结束/任务切换）、规则输入与 `0/3/8/15` 档位输出已实现。

### FR-006 事件流与可追溯性

- [x] 计时与标签相关动作写入 `time_events`（追加写）。
- [x] 从事件流重放计算时长已实现。
- [ ] 事件重放一致性的自动化测试尚未实现（逻辑已具备，验收证据不足）。

## 3) MVP 开发顺序文档对照

### 阶段 0 先决条件

- [x] Tauri + Svelte + Rust 骨架可运行。
- [x] `invoke` 的 `ping` 命令链路可用。

### 阶段 A 可信计时底座

- [x] A1 存储与迁移：SQLite schema + `user_version` migration + 索引/外键已实现。
- [x] A2 状态机命令：文档列出的 8 个命令均已实现。
- [ ] A2 完成标准中的“所有命令通过单元测试”未完成。
- [x] A3 事件重放与统计计算已实现（含日/周窗口）。
- [x] A3 可输出任务级耗时排行榜（前端 Top 列表）。

### 阶段 B 端到端 MVP 切片

- [x] B1 最小前端界面：任务树、计时控制、插入子任务、标签编辑已实现。
- [x] B1 完整链路可在 UI 操作完成（创建主任务 -> 开始 -> 插入子任务 -> 停止子任务 -> 回父任务 -> 结束）。
- [x] B2 任务 `inclusive/exclusive` 列表已实现。
- [ ] B2 按标签聚合耗时未实现。

### 阶段 C 自适应休息 + 稳定性

- [x] C1 规则版休息建议已实现。
- [ ] C2 异常退出恢复、幂等策略系统化、性能指标验收未完成。

### 测试与 Gate

- [ ] 状态机单元测试未实现。
- [ ] 事件重放统计测试未实现。
- [ ] 命令层集成测试未实现。
- [ ] 前端关键路径冒烟测试未实现。
- [ ] Gate-A / Gate-B / Gate-C 尚未正式验收。

## 4) ADR 对照

- [x] ADR-001 事件溯源：采用 `time_events` + 重放计算。
- [x] ADR-002 单活动上下文：已实现。
- [x] ADR-003 子任务插入语义：已实现。
- [x] ADR-004 Inclusive/Exclusive 双口径：已实现。
- [x] ADR-005 SQLite + rusqlite(bundled) + migration：已实现。
- [x] ADR-006 邻接表（`parent_id`）：已实现。
- [x] ADR-007 事件最小集合：`reparent` 已接入命令层并写入事件流。
- [x] ADR-008 命令式后端 + IPC：已实现（前端统一 invoke Rust 命令）。
- [x] ADR-009 Capabilities 最小化：当前权限为 `core:default` + `opener:default`，可运行 MVP。
- [x] ADR-010 规则版休息建议已实现（规则命中可解释 + 接受/忽略）。
- [ ] ADR-011 为 Proposed，当前不适用。
- [x] ADR-012 未过度抽象：当前保持最小分层。

## 5) 代码证据（便于复核）

- [x] 命令注册与状态注入：`src-tauri/src/lib.rs`
- [x] SQLite 初始化与 migration：`src-tauri/src/infra/sqlite.rs`
- [x] 核心状态机与事件重放：`src-tauri/src/app/service.rs`
- [x] Tauri 命令层：`src-tauri/src/commands/mod.rs`
- [x] 前端 API 封装：`src/lib/api.ts`
- [x] 前端 MVP 页面：`src/routes/+page.svelte`

## 6) 结论（当前完成度）

- [x] 已完成：阶段 0、阶段 A 的核心实现、阶段 B 的主链路可用。
- [ ] 未完成：测试体系、标签聚合统计、瓶颈提示、稳定性与 Gate 验收。
