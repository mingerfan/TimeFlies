# TimeFiles 命令模式设计文档（v0.2）

- 日期：2026-02-25
- 状态：Draft
- 作用范围：P2（命令模式 MVP） + P3（自动补全与高效交互）

## 1. 背景与目标

主界面空间有限，GUI 控件过多会挤占任务名称与状态信息。  
面向键盘重度用户，提供 `/` 指令与 `#tag` 语法，降低鼠标依赖并提升输入效率。

目标：

1. 在主界面以一条输入栏完成高频操作（重命名、改父级、打标签、开始/暂停/停止）。
2. 指令与自然文本共存，默认行为可预测。
3. 后续平滑升级为自动补全与命令历史系统。

## 2. P2：命令模式 MVP

## 2.1 入口

主界面新增 `CommandBar`（单行输入）：

1. 前缀 `/`：命令模式。
2. 包含 `#xxx`：标签语法。
3. 无前缀纯文本：默认创建任务（当前任务子任务优先）。

## 2.2 MVP 命令集合

以下命令先实现，均作用于“当前选中任务”或命令指定任务：

1. `/rename <title>`
   - 重命名当前任务。
2. `/parent root`
   - 设为根任务（`parent_id = null`）。
3. `/parent <task_id_or_title>`
   - 修改父任务。
4. `/start`
   - 开始当前任务（若其他任务 running，先暂停它）。
5. `/pause`
   - 暂停当前任务。
6. `/resume`
   - 恢复当前任务。
7. `/stop`
   - 停止当前任务。
8. `/sub <title>`
   - 在当前 running 任务下插入并开始子任务；否则创建子任务。

## 2.3 标签语法

1. 输入中出现 `#tag` 自动解析为标签。
2. 示例：`写周报 #work #writing`
3. 标签解析后调用 `addTagToTask`。
4. 解析失败不阻塞主动作（先完成任务创建/命令，再提示标签异常）。

## 2.4 解析与执行顺序

优先级：

1. `/` 命令（最高）
2. 普通文本创建任务
3. `#tag` 附加处理

执行策略：

1. 先完成主命令或主动作。
2. 再执行标签追加。
3. 所有失败均行内反馈，不弹窗打断。

## 2.5 反馈机制

CommandBar 下方显示一行结果：

1. 成功：`已重命名为 xxx`
2. 失败：`命令错误：/parent 目标不存在`
3. 支持最近 1 次撤销提示（仅对可逆动作）

## 3. P3：自动补全与高效交互

## 3.1 自动补全（阶段 1）

1. 输入 `/` 显示命令候选：
   - `rename`, `parent`, `start`, `pause`, `resume`, `stop`, `sub`
2. `/parent ` 后显示任务候选（标题 + 路径）。
3. 输入 `#` 显示标签候选（历史标签）。

## 3.2 键盘交互

1. `Tab`：接受当前补全。
2. `Shift+Tab`：反向切换补全项。
3. `Enter`：执行。
4. `Esc`：关闭补全或清空输入。
5. `ArrowUp/ArrowDown`：命令历史回溯。

## 3.3 命令历史

1. 仅本地存储，默认保留最近 50 条。
2. 支持去重（连续相同命令折叠）。
3. 支持快速复用最近一条命令。

## 3.4 容错与安全

1. 模糊匹配只用于候选，不直接自动执行。
2. 高风险命令（如归档）默认要求显式命令：
   - `/archive confirm`
3. 多义目标（如同名任务）必须二次选择。

## 4. 数据与实现边界

1. 前端新增：
   - `src/lib/command/parser.ts`：词法与语义解析
   - `src/lib/command/executor.ts`：命令到 API 映射
   - `src/lib/components/CommandBar.svelte`
2. 现有 Rust 命令复用优先，不够再增量扩展。
3. 所有命令执行仍走 Tauri 命令边界，禁止前端直改存储。

## 5. 验收标准（P2/P3）

P2 验收：

1. `/rename`、`/parent`、`/start|pause|resume|stop`、`/sub` 可用。
2. `#tag` 能被解析并写入标签。
3. 不使用鼠标也能完成一条任务从创建到开始计时。

P3 验收：

1. 命令补全、标签补全可用。
2. 命令历史可回溯。
3. 命令执行成功率与 GUI 操作一致，错误可解释。
