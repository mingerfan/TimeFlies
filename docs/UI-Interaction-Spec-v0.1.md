# TimeFiles UI/Interaction 设计规格（v0.1）

- 日期：2026-02-25
- 状态：Draft（待确认后进入实现）
- 依据：`docs/PRD-TimeFiles-v0.1.md`、`docs/ADR-Core-Decisions-v0.1.md`

## 1. 设计目标

1. 任务详情与添加任务成为主工作区，保证“快 + 好用”。
2. 任务树从按钮式改为可展开/收起的多级列表。
3. 计时器采用“任务会话正计时”，不采用固定番茄倒计时。
4. 统计摘要降级为次级页面，避免主流程被稀释。

## 2. 信息架构与路由

1. `任务执行`（默认页）：
   - 路由：`/`
   - 包含任务树 + 任务详情 + 快速添加 + 常驻迷你计时器
2. `计时器`（专注页）：
   - 路由：`/timer`
   - 大号计时器 + 当前任务上下文 + 快速切换
3. `统计摘要`（次级页）：
   - 路由：`/summary`
   - 展示休息建议、Top 耗时任务等摘要信息

## 3. 全局布局

1. 左侧 Sidebar（固定 220px）：
   - 页面切换
   - 当前任务与计时状态
   - 迷你计时控制（开始/暂停/停止）
2. 主内容区：
   - 任务执行页：`32%（任务树） + 68%（详情工作区）`
   - 计时器页：主计时区优先，辅助信息次之
   - 统计页：卡片流式布局

线框：

```text
+--------------------+----------------------------------------------+
| Sidebar            | Main Content                                 |
| - 任务执行         |                                              |
| - 计时器           |                                              |
| - 统计摘要         |                                              |
|                    |                                              |
| [当前任务/计时]    |                                              |
| [开始/暂停/停止]   |                                              |
+--------------------+----------------------------------------------+
```

## 4. 任务执行页（核心）

线框：

```text
+--------------------+---------------------------+------------------------------+
| Sidebar            | 任务树 32%                | 详情工作区 68%               |
|                    | [搜索/过滤(预留)]         | [标题 + 路径 + 状态 + 主操作] |
|                    | ▸ 任务 A                  | ---------------------------- |
|                    |   ▾ 子任务 A1             | [任务说明]                   |
|                    |     ▸ 子任务 A1-1         | [子任务列表]                 |
|                    | ▸ 任务 B                  | [最近会话时间线]             |
|                    |                           | ---------------------------- |
|                    |                           | [快速添加输入区(固定底部)]    |
+--------------------+---------------------------+------------------------------+
```

### 4.1 任务树交互

1. 行结构：`展开箭头 + 标题 + 状态 + Ex/In 时长`。
2. 支持无限层级，缩进步长 `16px`，行高 `34px`。
3. 展开/收起：
   - 鼠标点击箭头
   - 键盘 `Left/Right`
4. 选中与激活高亮：
   - 当前运行叶子任务：深色块包裹（高对比）
   - 当前任务祖先链：浅色块包裹（路径感）
   - 路径左侧统一色条
5. 键盘导航：
   - `Up/Down` 上下移动
   - `Enter` 对选中任务执行“开始/恢复”
   - `Ctrl+Enter` 新建同级任务

### 4.2 详情工作区

1. 顶部固定区：
   - 任务名（可编辑）
   - 面包屑路径
   - 状态标签
   - 主操作按钮（开始/暂停/停止/插入子任务）
2. 主体区：
   - 描述/备注（MVP 可先文本）
   - 子任务列表（轻量信息）
   - 会话时间线（start/pause/resume/stop 记录）
3. 底部固定“快速添加”：
   - 输入框始终可见，不随滚动消失
   - 优先保证单手键盘快速录入

### 4.3 快速添加任务

1. 默认插入位置：
   - 有选中任务：作为其子任务
   - 无选中任务：创建根任务
2. 快捷行为：
   - `Enter`：创建
   - `Ctrl+Enter`：创建并开始
   - `Esc`：清空输入
3. 运行中场景：
   - 若当前选中任务为 `running`，优先触发“插入子任务并开始”
4. 轻语法（MVP 可选）：
   - 示例：`写周报 /tag work /est 45m`
   - 解析失败时仍创建纯标题任务，不阻塞

## 5. 计时器页（非番茄）

### 5.1 核心原则

1. 仅“正计时”显示任务会话已专注时长。
2. 不做固定 25/40 分钟机械中断。
3. 休息建议只在任务边界触发（任务切换/子任务结束）。
4. 建议可接受或忽略，不强制中断。

### 5.2 页面结构

1. 顶部：
   - 当前任务路径
   - 任务状态
   - 今日累计/任务累计
2. 中央：
   - 大号运行时钟 `HH:MM:SS`
3. 底部操作：
   - 开始、暂停、停止
   - 插入子任务并开始
4. 侧边辅助：
   - 最近任务列表（一键切换）

线框：

```text
+--------------------------------------------------------------+
| 当前路径: 项目A / 模块B / 子任务C            状态: running   |
| 今日累计: 02:35:10     当前任务累计: 01:14:22                |
|                                                              |
|                        00:42:18                              |
|                                                              |
| [开始] [暂停] [停止] [插入子任务并开始]                        |
| ------------------------------------------------------------ |
| 最近切换: [任务X] [任务Y] [任务Z]                             |
+--------------------------------------------------------------+
```

### 5.3 状态机与命令映射

1. 状态：`idle`、`running`、`paused`、`stopped`。
2. 命令映射：
   - 开始：`start_task`
   - 暂停：`pause_task`
   - 恢复：`resume_task`
   - 停止：`stop_task`
   - 插入子任务并开始：`insert_subtask_and_start`
3. 单活动上下文：
   - 前端遇到“已有 running 任务”错误时，提示切换到活动任务并聚焦它。

### 5.4 自适应休息建议交互

1. 触发点：
   - 子任务结束
   - 任务切换
2. 展示方式：
   - 非模态建议条（不打断输入）
3. 操作：
   - `接受`：写入 `respond_rest_suggestion(accept=true)`，并建议进入短休息
   - `忽略`：写入 `respond_rest_suggestion(accept=false)`
4. 建议文案应展示触发原因（连续专注时长/切换频率/历史偏差）。

## 6. 组件清单（Svelte）

1. `src/lib/components/app-shell/Sidebar.svelte`
2. `src/lib/components/app-shell/MiniTimerControls.svelte`
3. `src/lib/components/tasks/TaskTree.svelte`
4. `src/lib/components/tasks/TaskTreeItem.svelte`
5. `src/lib/components/tasks/TaskDetailsPanel.svelte`
6. `src/lib/components/tasks/QuickAddBar.svelte`
7. `src/lib/components/timer/FocusTimerPanel.svelte`
8. `src/lib/components/timer/RestSuggestionBanner.svelte`
9. `src/lib/components/summary/SummaryPanels.svelte`

## 7. 状态与数据边界

1. 共享状态（前端）：
   - `overview`
   - `selectedTaskId`
   - `expandedTaskIds`
   - `activeRoute`
2. 后端真相（Rust + SQLite）：
   - 任务状态机
   - 事件日志
   - inclusive/exclusive 计算
3. 前端不直接改统计，所有写操作经 Tauri 命令。

## 8. 快捷键（MVP）

1. `Space`：开始/暂停（针对当前选中任务）
2. `S`：停止
3. `I`：插入子任务并开始
4. `N`：聚焦快速添加输入框
5. `[` / `]`：切换 Sidebar 页面

## 9. 异常与边界行为

1. 停止 `idle` 任务：提示不可操作。
2. 运行时插入子任务失败：保留输入内容，提示原因。
3. 活动任务被归档/重挂失败：展示后端错误并刷新状态。
4. 数据加载失败：页面保留骨架与重试按钮，不清空用户输入框。

## 10. 实施顺序（建议）

1. 新建路由与全局布局（Sidebar + 三页面骨架）。
2. 任务树替换为可展开树结构，接入祖先链与叶子高亮。
3. 重做详情区与底部快速添加条。
4. 新建计时器页并复用状态机命令。
5. 统计摘要迁移到 `/summary`，保留现有数据能力。

## 11. 验收标准（本次改版）

1. 用户 2 秒内可开始一个任务，1 秒内可插入子任务。
2. 树上能清晰分辨“当前活动叶子任务”和“其祖先链路”。
3. 任务详情与快速添加区域在主页面中占最大可视面积。
4. 全程不出现番茄倒计时交互，仅任务会话计时 + 边界休息建议。
